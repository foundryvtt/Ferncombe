export default class Macros {

  async planarTransition() {
    const planes = {
      "material": {
        "label": "Material Plane",
        "locations": {
          "attic": {
            "scene": "KcLoYTJA8lRX9BNs",
          },
          "firstfloor": {
            "scene": "zA8TGJrK0CHBM0VO",
          },
          "grounds": {
            "scene": "kNmvb94sA8xxCaB4",
          },
          "secondfloor": {
            "scene": "zhDAyG12UoLvMQGF",
            "points": {
              "library": {
                "journal": "JournalEntry.GfWgVX7GYShBa9bG.JournalEntryPage.soZoOChqyxbwDfLh",
                "spaces": [ [ 44, 17 ], [ 43, 16 ], [ 43, 14 ], [ 41, 15 ], [ 42, 16 ], [ 41, 17 ], [ 42, 18 ], [ 43, 18 ], [ 42, 14 ], [ 44, 15 ] ]
              }
            }
          },
          "grove": {
            "scene": "k5P185xkx2LZumlQ",
            "points": {
              "tree": {
                "journal": "JournalEntry.fnNToxGl9e4bBlrv.JournalEntryPage.JezR262gGav5xh6t",
                "spaces": [ [ 27, 22 ], [ 27, 24 ], [ 27, 26 ], [ 28, 23 ], [ 28, 25 ], [ 29, 22 ], [ 29, 24 ], [ 29, 26 ], [ 28, 21 ], [ 28, 27 ] ]
              }
            }
          },
        }
      },
      "feyward": {
        "label": "Feyward Plane",
        "locations": {
          "attic": {
            "scene": "awRXbAhbgiVihLy8",
          },
          "firstfloor": {
            "scene": "VqwR81AQpI0sj9gj",
            "points": {
              "mirror": {
                "journal": "JournalEntry.9cQ3NRZsM5PIx7X7.JournalEntryPage.vs6YMdSPzQrrDprq",
                "spaces": [ [ 22, 19 ], [ 23, 18 ], [ 22, 18 ], [ 21, 17 ], [ 20, 17 ], [ 21, 16 ], [ 22, 16 ], [ 23, 16 ], [ 20, 19 ], [ 20, 18 ] ]
              }
            }
          },
          "grounds": {
            "scene": "038SJS5WR7iupxp9",
            "points": {
              "gate": {
                "journal": "JournalEntry.Lk3JEQQR4aiZNiO2.JournalEntryPage.wDcliOhnpVLCOra9",
                "spaces": [ [ 14, 43 ], [ 15, 43 ], [ 14, 45 ], [ 14, 44 ], [ 15, 45 ], [ 15, 46 ], [ 15, 42 ], [ 15, 44 ], [ 16, 42 ], [ 16, 46 ] ]
              }
            }
          },
          "secondfloor": {
            "scene": "SeabOkUhJoNGwweJ",
            "points": {
              "library": {
                "journal": "JournalEntry.S4cjQ4a20BmnK3ij.JournalEntryPage.knvRiXsZ310oq32Q",
                "spaces": [ [ 45, 21 ], [ 44, 22 ], [ 45, 22 ], [ 44, 21 ], [ 44, 20 ], [ 44, 19 ], [ 45, 20 ], [ 46, 21 ], [ 46, 20 ], [ 45, 19 ] ]
              },
              "foyer": {
                "journal": "JournalEntry.S4cjQ4a20BmnK3ij.JournalEntryPage.p49DYps82IZEtzVO",
                "spaces": [ [ 38, 25 ], [ 37, 25 ], [ 40, 26 ], [ 38, 26 ], [ 39, 26 ], [ 36, 25 ], [ 40, 27 ] ]
              }
            }
          },
          "grove": {
            "scene": "4dgUsDKiirK72yDj",
          },
        }
      },
      "shadeward": {
        "label": "Shadeward Plane",
        "locations": {
          "attic": {
            "scene": "gLsGFqln6JSAS9Zx",
          },
          "firstfloor": {
            "scene": "y8XJ72BhHNYCAXvO",
            "points": {
              "mirror": {
                "journal": "JournalEntry.2hdVeUnyNT1PHuFD.JournalEntryPage.1Bo1vfxHbLg8AAzw",
                "spaces": [ [ 21, 16 ], [ 22, 16 ], [ 23, 16 ], [ 21, 17 ], [ 20, 17 ], [ 23, 18 ], [ 22, 18 ], [ 20, 18 ], [ 22, 19 ], [ 20, 19 ] ]
              }
            }
          },
          "grounds": {
            "scene": "Z1jqEpH0lUQp1x14",
            "points": {
              "gate": {
                "journal": "JournalEntry.LacLs8vM3Phjhl4R.JournalEntryPage.StmGOfBHMjyue7VV",
                "spaces": [ [ 14, 44 ], [ 15, 44 ], [ 15, 45 ], [ 14, 45 ], [ 14, 43 ], [ 15, 43 ], [ 16, 42 ], [ 16, 46 ], [ 13, 44 ], [ 13, 43 ], [ 13, 45 ], [ 15, 46 ] ]
              }
            }
          },
          "secondfloor": {
            "scene": "h4ttW6VFF2dDVKpV",
            "points": {
              "library": {
                "journal": "JournalEntry.2hdVeUnyNT1PHuFD.JournalEntryPage.soZoOChqyxbwDfLh",
                "spaces": [ [ 44, 18 ], [ 45, 18 ], [ 44, 19 ], [ 45, 19 ], [ 46, 19 ], [ 45, 20 ], [ 44, 20 ], [ 46, 20 ], [ 44, 21 ], [ 45, 21 ] ]
              }
            }
          },
          "grove": {
            "scene": "OrPh71vbIEAa026M",
          },
        }
      },
      "planar": {
        "label": "Planar Sanctum",
        "locations": {
          "sanctum": {
            "scene": "rRY9Y8jNBkPbmcUl",
            "points": {
              "atrium": {
                "journal": "JournalEntry.qokqJHkJY1uv6PoD.JournalEntryPage.xMucDp9xFxi3M70j",
                "spaces": [[38,30],[38,29],[39,29],[40,29],[40,30],[39,30],[39,31],[38,31],[40,31],[39,28],[37,30],[39,32],[41,30]]
              }
            }
          }
        }
      }
    }

    const selected = canvas.activeLayer.controlled;

    const title = "Planar Transition";
    const content = `
  <label for="destinations">Choose a destination:</label>
  <select name="destinations" id="destination">
    <optgroup label="Material Plane">
      <option value="material-_-same">Same location in the Material Plane</option>
      <option value="material-secondfloor-library">Library Balcony</option>
      <option value="material-grove-tree">The Great Tree</option>
    </optgroup>
    <optgroup label="Shadeward Plane">
      <option value="shadeward-_-same">Same location in the Shadeward Plane</option>
      <option value="shadeward-firstfloor-mirror">The Gallery</option>
      <option value="shadeward-secondfloor-library">Library Balcony</option>
      <option value="shadeward-grounds-gate">The Autumnal Gate</option>
    </optgroup>
    <optgroup label="Feyward Plane">
      <option value="feyward-_-same">Same location in the Feyward Plane</option>
      <option value="feyward-firstfloor-mirror">The Gallery</option>
      <option value="feyward-secondfloor-library">Library Gangways</option>
      <option value="feyward-secondfloor-foyer">Foyer Balcony</option>
      <option value="feyward-grounds-gate">The Midnight Gate</option>
    </optgroup>
    <optgroup label="Planar Sanctum">
      <option value="planar-sanctum-atrium">The Fractured Atrium</option>
    </optgroup>
  </select> 
  <br>
  <input type="checkbox" name="activate" id="activate" checked="true">
  <label for="activate">Activate Destination Scene</label>
  `;
    let destination;
    let activate;
    await Dialog.prompt({
      title, content,
      render: (html) => {
        destination = html[0].querySelector("#destination");
        activate = html[0].querySelector("#activate");
      },
    });

    const targetPlane = destination.value.split("-")[0];
    if ( !targetPlane ) return;
    let targetLocation = destination.value.split("-")[1];
    const targetPoint = destination.value.split("-")[2];

    const currentPlane = Object.entries(planes).find(p => Object.values(p[1].locations).map(l => l.scene).includes(canvas.scene.id))[0];
    if ( targetPoint === "same" ) targetLocation = Object.entries(planes[currentPlane].locations).find(l => l[1].scene === canvas.scene.id)[0];

    const targetScene = game.scenes.get(planes[targetPlane].locations[targetLocation].scene);

    if ( targetPoint === "same" ) {
      await targetScene.createEmbeddedDocuments("Token", selected.map(s => s.document), {});
    } else {
      const point = planes[targetPlane].locations[targetLocation].points[targetPoint];
      let toCreate = [];
      let count = 0;
      for ( const token of selected.map(s => foundry.utils.duplicate(s.document)) ) {
        const spaceIndex = count % point.spaces.length;
        const space = point.spaces[spaceIndex];

        // Translate to X / Y
        const grid = canvas.grid.grid.getPixelsFromGridPosition(space[0], space[1]);
        token.x = grid[0]
        token.y = grid[1];
        toCreate.push(token);
        count++;
      }
      await targetScene.createEmbeddedDocuments("Token", toCreate, {});
      const journal = await fromUuid(point.journal);
      const pageId = point.journal.split(".")[3];
      journal.parent.sheet.render(true, {pageId: pageId, focus: true})
    }
    await game.scenes.get(canvas.scene.id).deleteEmbeddedDocuments("Token", selected.map(c => c.document._id), {});

    console.log(activate.checked);
    if ( activate.checked ) {
      targetScene.activate();
    }
    else {
      // Pull players who had their tokens moved to the target scene
      for ( const token of selected ) {
        const player = game.users.find(u => u.character?._id == token.document.actor._id);
        if ( player ) {
          game.socket.emit("pullToScene", targetScene.id, player.id);
        }
      }
    }
  }
}
